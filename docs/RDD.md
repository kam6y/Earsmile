# 要件定義書：聴覚障害・難聴の高齢者向け音声テキスト化アプリ

## 1. プロジェクト概要

### 1.1 背景と目的
加齢に伴う難聴により、コミュニケーションが困難になっている高齢者を支援する。
既存アプリの課題（ボタンが小さい、機能過多、複雑な設定）を解消し、ITリテラシーが高くない高齢者でも直感的に使える「会話の見える化」ツールを提供する。

### 1.2 ターゲットユーザー
- **メインユーザー**: 聴覚に障害を持つ、または加齢性難聴のある高齢者（70代〜90代）。
- **サブユーザー**: その家族、介護士、医師など（話者となる人）。

### 1.3 対応プラットフォーム
- **OS**: iOS 16以上, iPadOS 16以上
- **デバイス**: iPhone, iPad（特にiPadの大画面活用を重視）

## 2. システムアーキテクチャ

### 2.1 全体構成図
- **Frontend**: Flutter (iOS/iPadOS app)
- **Backend**: Firebase (Auth, Firestore, Functions)
- **AI/ML**: Apple Speech Framework (On-device), OpenAI Whisper (Cloud Functions)

### 2.2 データフロー
1.  **音声入力**: デバイスのマイクから音声を取得。
2.  **音声認識 (On-device)**: Apple Speech Framework (SFSpeechRecognizer) でリアルタイムにテキスト化。
    -   *オフライン対応*: ネットワーク接続がない場合でも動作可能にする。
3.  **UI表示**: 認識されたテキストをリアルタイムで画面に表示。
4.  **データ保存**:
    -   **ローカル**: アプリ内データベース (ObjectBox) に一時保存（オフライン時含む）。
    -   **クラウド**: ネットワーク接続時に Firestore へ同期（設定でオプトアウト可能）。
5.  **高精度変換 (オプション)**:
    -   ユーザーが明示的に「AI変換」を実行した場合、直近の音声データを Cloud Functions へ送信。
    -   OpenAI Whisper API でテキスト化し、結果を UI と Firestore に反映。

## 3. 機能要件詳細

### 3.1 優先度: 高 (MVP)

#### 3.1.1 リアルタイム音声文字変換
-   **起動即認識**: アプリ起動と同時にマイク権限を確認し、音声認識待機状態にする。
-   **ストリーミング表示**: 話している途中でも文字が次々と表示される（Partial Results）。
-   **無音検知**: 
    -   1.5秒以上の無音で「文の区切り」とみなし、改行を挿入。
    -   Apple Speech Framework の `isFinal` フラグも活用。
-   **エラーハンドリング**:
    -   マイク権限拒否時: 大きな図解付きで「設定からマイクをオンにしてください」と誘導。
    -   音声認識エラー（インターネット無し等）: オフラインモードでの動作を継続し、最上部に「オフライン」アイコンを表示。

#### 3.1.2 超・視認性UI
-   **ダイナミックタイプ拡張**:
    -   独自スライダーで以下のサイズ段階を提供。
        -   大 (24pt)
        -   特大 (32pt)
        -   最大 (48pt) - iPad推奨
-   **高コントラストモード**:
    -   モード切替スイッチを常設。
    -   通常: 白背景(#FFFFFF) + 黒文字(#000000)
    -   高コントラスト: 黒背景(#000000) + 黄色文字(#FFFF00)
    -   弱視対応: フォントウェイトを Bold に固定。

#### 3.1.3 会話履歴の表示と削除
-   **履歴リスト**:
    -   日時 ("10月20日 14:30") と冒頭の文章を表示。
    -   リスト項目は高さ80pt以上確保。
-   **削除フロー**:
    -   履歴詳細画面に「削除」ボタン（赤色背景、白文字）。
    -   確認ダイアログ: 「本当に消しますか？」、「はい」「いいえ」の2択。ボタンサイズは大きく。

#### 3.1.4 完全匿名利用 (Auth)
-   **匿名認証**: `FirebaseAuth.instance.signInAnonymously()` をアプリ初回起動時に実行。
-   **セッション維持**: アプリを再起動しても同じ UID を利用。
-   **機種変更時の対応 (Ver 2.0以降検討)**: 現段階では機種変更時のデータ移行は考慮しない（シンプルさ優先）。

### 3.2 優先度: 中 (Ver 1.5)

#### 3.2.1 「聞いています」フィードバック
-   **波形アニメーション**:
    -   音声入力レベル (Audio Level) に応じてバーの高さや色が変化するアニメーション。
    -   「音が入力されている」ことを視覚的にフィードバック。

#### 3.2.2 定型文表示 (発話補助)
-   **定型文ボタン**:
    -   画面下部に横スクロール可能なボタン列。
    -   例: 「聞こえました」「もう一度」「わかりません」
-   **アクション**:
    -   タップすると、その文言を画面に大きく表示（相手に見せる用）。
    -   同時に音声合成 (Text-to-Speech) で読み上げる（設定でOn/Off）。

#### 3.2.3 会話ログのクラウド保存
-   **Firestore同期**:
    -   会話終了ボタン押下時に Firestore へ `Conversations` ドキュメントを作成。
    -   `Messages` サブコレクションに発話内容を保存。

### 3.3 優先度: 低 (Ver 2.0)

#### 3.3.1 高精度AI変換モード (Whisper)
-   **トリガー**: 履歴詳細画面で「AIで変換し直す」ボタン。
-   **処理**: 録音された音声データ（一時保存が必要）をアップロードし、サーバー側で Whisper 処理。
-   **UI反映**: 処理完了後、テキストを書き換える。

## 4. UI/UX デザイン仕様

### 4.1 共通ルール (Accessibility)
-   **ターゲットサイズ**: 全てのタッチターゲットは **64x64pt 以上** (Apple推奨の44ptより大きく)。
-   **フォント**: ヒラギノ角ゴシック (Hiragino Sans) - 視認性が高いため。
-   **アイコン**: SF Symbols を使用し、太めのウェイト (Bold/Heavy) を指定。

### 4.2 画面遷移図
1.  **Splash Screen**: ロゴ表示 → 認証/権限チェック → Homeへ
2.  **Home Screen (聴取画面)**:
    -   メイン機能。起動直後からここは表示される。
    -   [画面中央]: テキスト表示エリア（自動スクロール）。
    -   [画面中央]: テキストデータ | ObjectBox（暗号化サポート検討）に保存
    -   [画面下部]: 操作パネル（「停止/再開」ボタン、「設定」へのリンク、「履歴」へのリンク）。
3.  **History Screen (履歴一覧)**:
    -   日付順リスト。
    -   各行: 日付 + プレビューテキスト。
    -   [戻る] ボタン（左上、特大）。
4.  **Settings Screen (設定)**:
    -   文字サイズスライダー。
    -   コントラスト切替スイッチ。
    -   [戻る] ボタン。

## 5. データモデル設計 (詳細)

### 5.1 Firestore Schema

#### `users/{userId}`
-   `createdAt`: timestamp
-   `lastLogin`: timestamp
-   `platform`: string ("ios", "ipados")
-   `appVersion`: string
-   `settings`: map
    -   `fontSize`: number (1.0 ~ 3.0 scale factor)
    -   `isHighContrast`: boolean

#### `users/{userId}/conversations/{conversationId}`
-   `startedAt`: timestamp
-   `endedAt`: timestamp
-   `title`: string (デフォルトは "YYYY/MM/DD HH:mm の会話")
-   `summary`: string (AIによる要約 - 将来的)
-   `isFavorite`: boolean

#### `users/{userId}/conversations/{conversationId}/messages/{messageId}`
-   `timestamp`: timestamp
-   `text`: string
-   `confidence`: number (0.0 - 1.0)
-   `isFinal`: boolean (確定したテキストか)

### 5.2 Local Storage (Shared Preferences / ObjectBox)
-   **Settings**: オフラインでも即座に反映するため、設定値はローカルに優先保存。
-   **Drafts**: 送信前の会話データなど。

## 6. 非機能要件

### 6.1 パフォーマンス
-   **起動速度**: アイコンタップから音声認識開始まで **2秒以内**。
-   **レイテンシ**: 発話から画面表示まで **0.5秒以内** (On-device STT)。

### 6.2 セキュリティ
-   **プライバシー**: 音声データは原則デバイス内で処理（Whisper利用時を除く）。
-   **データ送受信**: HTTPS通信のみ。

### 6.3 可用性
-   **オフライン動作**: ネット環境がなくても基本機能（音声字幕化）は利用可能であること。
